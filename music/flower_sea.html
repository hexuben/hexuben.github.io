<!DOCTYPE html>
<html>
<head>
	<title></title>
	<script src="https://apps.bdimg.com/libs/jquery/2.1.4/jquery.min.js"></script>
	<link rel="stylesheet" type="text/css" href="style.css">
	<script>
		function loadfile(filename,func){
			let url=filename;
			let httpRequest=new XMLHttpRequest();
			httpRequest.open('GET',url,true);
			httpRequest.send();
			httpRequest.onreadystatechange=function(){
				if (httpRequest.readyState==4 && httpRequest.status==200)
					func(httpRequest.responseText);
			};
		}
		function loadLyric(url){
			loadfile(url, function(tmp){
				var tmp = tmp.split('\n');
				var lrc = new Array();
				for(var i = 0; i < tmp.length; i++){
					if(tmp[i] != "") lrc.push(tmp[i]);
				}
				var singer = new Array();
				for(var data of lrc){
					if(data.charAt(0) == '#'){
						var matcher = /#([a-z]*?): (.*)/;
						if (matcher.exec(data)){
							var res = matcher.exec(data);
							if(res[1] == "singer"){
								singer = res[2].split(',');
							}
							singer.forEach((item) => {
								item = item.trim();
							});
						}
					} else if(data.charAt(0) == '{'){
						var matcher = /{(.*?) ([\d,]*?)}/;
						// console.log(data);
						if(matcher.exec(data)){
							var instruct = matcher.exec(data);
							// console.log(instruct);
							if(instruct[1] == "singer"){
								var parameter = instruct[2].split(',');
								var code = "";
								parameter.forEach((tmp) => {
									code += ", " + singer[Number(tmp) - 1];
								});
								// console.log(parameter);
								$("#my-lyric").append(`<p class="lyric-singer">${code.substring(2)}</p>`);
							}
						}
					} else {
						var a = new Array(), b = new Array();
						var matcher1 = /(.)</g, matcher2 = /<(.*?)>/g, res;
						while (res = matcher1.exec(data)){
							for(var i = 1; i < res.length; i++){
								a.push(res[i]);
							}
						}
						while (res = matcher2.exec(data)){
							for(var i = 1; i < res.length; i++){
								b.push(res[i]);
							}
						}
						var code = data;
						code = code.replaceAll(/<.*?>/g, "");
						for(var i = 0; i < a.length; i++){
							code = code.replaceAll(a[i], `<ruby>${a[i]}<rt style="font-size: 80%;">${b[i]}</rt></ruby>`);
						}
						$("#my-lyric").append(`<p class="lyric-normal">${code}</p>`);
					}
					
				}
			});
		};
		$(document).ready(function(){
			loadLyric("https://hexuben.github.io/music/花海（花の海）.txt");
		});
	</script>
</head>
<body>
	<div class="lyric" id="my-lyric">
		
	</div>
</body>
</html>
